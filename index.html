<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç´›å¤±é˜²æ­¢ã‚¢ãƒ—ãƒª Ã— M5Stack Lost Alert</title>

<link rel="stylesheet" href="style.css">

</head>
<body>

<!-- ===== ãƒ¡ã‚¤ãƒ³ç”»é¢ ===== -->
<div id="mainPage" class="page active">
  <div class="header">ç´›å¤±é˜²æ­¢ã‚¢ãƒ—ãƒª</div>

  <div class="status">
    <span id="circle" class="circle">ğŸ”´</span>
    <span id="text">æœªæ¥ç¶š</span>
  </div>

  <div class="mode-switch">
    <button id="mode-lost" class="mode-btn active" onclick="setMode('lost')">ç´›å¤±é˜²æ­¢</button>
    <button id="mode-motion" class="mode-btn" onclick="setMode('motion')">å‹•ãæ¤œçŸ¥</button>
  </div>

  <div class="rssi-container" id="rssi-container">
    <div>ä¿¡å·å¼·åº¦: <span id="rssi-val">--</span> dBm</div>
    <div class="rssi-bar-bg"><div id="rssi-bar" class="rssi-bar-fill"></div></div>
  </div>

  <div class="button connect-btn" id="btn-connect" onclick="connect()">æ¥ç¶šã™ã‚‹</div>
  <div class="button disconnect-btn" id="btn-disconnect" onclick="disconnect()">åˆ‡æ–­ã™ã‚‹</div>

  <div class="button normal-btn button-nav" onclick="switchPage('menuPage')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
</div>

<!-- ===== ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ ===== -->
<div id="menuPage" class="page">
  <div class="header"></div>

  <p style="font-size:20px; font-weight:bold;">é€šçŸ¥</p>
  <label class="switch">
    <input type="checkbox" id="notif-switch">
    <span class="slider"></span>
  </label>
  <span id="notif-status" class="switch-status">ğŸ”• ã‚ªãƒ•</span>

  <p style="font-size:20px; font-weight:bold;">ãƒãƒŠãƒ¼ãƒ¢ãƒ¼ãƒ‰è¨­å®š</p>
  <div id="manner-setting-area"></div>

  <div id="last-location" class="location-info">
    <b>ğŸ“ åˆ‡æ–­åœ°ç‚¹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ:</b><br>
    <a id="map-link" href="#" target="_blank">Googleãƒãƒƒãƒ—ã§è¦‹ã‚‹</a>
    <div style="font-size:10px; color:#666; margin-top:5px;" id="timestamp"></div>
  </div>

  <div class="button normal-btn button-nav" onclick="switchPage('mainPage')">æˆ»ã‚‹</div>
</div>

<script>
// ================= ãƒšãƒ¼ã‚¸åˆ‡æ›¿ =================
function switchPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ================= Bluetooth åŸºæœ¬ =================
let device = null;
let motionChar = null;
let isManualDisconnect = false;
let currentMode = 'lost';
let isAlertShowing = false;
let isCooldown = false;

const SERVICE_UUID = "12345678-1234-1234-1234-1234567890ab".toLowerCase();
const CHAR_MOTION_UUID = "abcd1234-5678-90ab-cdef-1234567890ab".toLowerCase();

function setMode(mode){
  currentMode = mode;
  document.getElementById('mode-lost').className = mode==='lost'?'mode-btn active':'mode-btn';
  document.getElementById('mode-motion').className = mode==='motion'?'mode-btn active':'mode-btn';
  if(device && device.gatt.connected && motionChar){
    if(mode==='motion') motionChar.startNotifications().catch(()=>{});
    else motionChar.stopNotifications().catch(()=>{});
    document.getElementById("text").innerText = mode==='motion'?"ç›£è¦–ä¸­":"æ¥ç¶šä¸­";
  }
}

async function connect(){
  try{
    navigator.geolocation.getCurrentPosition(()=>{}, ()=>{});
    device = await navigator.bluetooth.requestDevice({filters:[{services:[SERVICE_UUID]}]});
    device.addEventListener('gattserverdisconnected', onDisconnected);

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);

    try{
      motionChar = await service.getCharacteristic(CHAR_MOTION_UUID);
      motionChar.addEventListener('characteristicvaluechanged', ()=>onMotionDetected());
      if(currentMode==='motion') await motionChar.startNotifications();
    } catch(e){}

    updateUI(true);
    isManualDisconnect=false;
    alert("âœ… æ¥ç¶šã—ã¾ã—ãŸ");
  } catch(e){
    alert("ã‚¨ãƒ©ãƒ¼: "+e);
  }
}

function disconnect(){
  if(device && device.gatt.connected){
    isManualDisconnect=true;
    device.gatt.disconnect();
    updateUI(false);
    alert("æ‰‹å‹•ã§åˆ‡æ–­ã—ã¾ã—ãŸ");
  }
}

function onDisconnected(){
  if(isManualDisconnect) return;

  document.getElementById("circle").innerText="âš ï¸";
  document.getElementById("text").innerText="æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸï¼";
  document.getElementById("text").className="alert-text";

  if(currentMode==='lost'){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude;
      const lng=pos.coords.longitude;
      document.getElementById("map-link").href=`https://www.google.com/maps?q=${lat},${lng}`;
      document.getElementById("timestamp").innerText=`æ™‚åˆ»: ${new Date().toLocaleTimeString()}`;
      document.getElementById("last-location").style.display="block";
    });
    setTimeout(()=>alert("âš ï¸ æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸ\n(ä½ç½®æƒ…å ±ã‚’è¨˜éŒ²)"),100);
  }
}

function onMotionDetected(){
  if(currentMode!=='motion' || isAlertShowing || isCooldown) return;
  isAlertShowing=true;

  document.getElementById("circle").innerText="âš ï¸";
  document.getElementById("text").innerText="å‹•ãã¾ã—ãŸï¼";
  document.getElementById("text").className="motion-text";

  setTimeout(()=>{
    alert("âš ï¸ å‹•ãã‚’æ¤œçŸ¥ã—ã¾ã—ãŸï¼");
    isAlertShowing=false;
    isCooldown=true;
    if(device && device.gatt.connected) updateUI(true);
    setTimeout(()=>isCooldown=false,5000);
  },100);
}

function updateUI(isConnected){
  if(isConnected){
    document.getElementById("circle").innerText="ğŸ”µ";
    document.getElementById("text").innerText=currentMode==='motion'?"ç›£è¦–ä¸­":"æ¥ç¶šä¸­";
    document.getElementById("btn-connect").style.opacity="0.5";
    document.getElementById("btn-disconnect").style.opacity="1.0";
  } else {
    document.getElementById("circle").innerText="ğŸ”´";
    document.getElementById("text").innerText="æœªæ¥ç¶š";
    document.getElementById("btn-connect").style.opacity="1.0";
    document.getElementById("btn-disconnect").style.opacity="0.5";
  }
}

// ================= é€šçŸ¥ã‚¹ã‚¤ãƒƒãƒ =================
const notifSwitch=document.getElementById("notif-switch");
const notifStatus=document.getElementById("notif-status");
notifSwitch.addEventListener("change",()=>{
  if(notifSwitch.checked){
    notifStatus.innerText = "ğŸ”” ã‚ªãƒ³";
    notifStatus.style.color = "green";
  } else {
    notifStatus.innerText = "ğŸ”• ã‚ªãƒ•";
    notifStatus.style.color = "gray";
  }
});
function canNotify(){ return notifSwitch.checked; }

// ================= ãƒãƒŠãƒ¼ãƒ¢ãƒ¼ãƒ‰UIç”Ÿæˆ =================
const area=document.getElementById("manner-setting-area");
for(let i=1;i<=5;i++){
  area.insertAdjacentHTML("beforeend",`
    <div class="accordion">
      <div class="accordion-header">è¨­å®š${i} â–¼</div>
      <div class="accordion-content">
        <input type="number" min="0" max="23"> :
        <input type="number" min="0" max="59">
        ï½ 
        <input type="number" min="0" max="23"> :
        <input type="number" min="0" max="59">
        <br><br>
        <button class="set-alarm-btn">è¨­å®š</button>
        <button class="stop-alarm-btn" style="display:none;">åœæ­¢</button>
      </div>
    </div>
  `);
}

// ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
document.querySelectorAll(".accordion-header").forEach(h=>{
  h.onclick=()=>{
    const content=h.nextElementSibling;
    // 1ã¤ã ã‘é–‹é–‰å¯èƒ½
    document.querySelectorAll(".accordion-content").forEach(c=>{
      if(c!==content) c.style.maxHeight=null;
    });
    content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight+"px";
  };
});

// ãƒãƒŠãƒ¼ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šï¼ˆ1åˆ†ã”ã¨æ›´æ–°ï¼‰
function checkMannerMode(){
  const now=new Date();
  const nowMin=now.getHours()*60+now.getMinutes();

  document.querySelectorAll(".accordion").forEach(acc=>{
    const inputs=acc.querySelectorAll("input");
    if(inputs.length!==4) return;

    let start=(inputs[0].value||0)*60+(inputs[1].value||0);
    let end=(inputs[2].value||0)*60+(inputs[3].value||0);

    let active=false;
    if(start<=end){
      if(nowMin>=start && nowMin<end) active=true;
    } else {
      if(nowMin>=start || nowMin<end) active=true;
    }
    acc.dataset.mannerActive = active ? "1" : "0";
  });
}
checkMannerMode();
setInterval(checkMannerMode,60000);

// ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
document.querySelectorAll(".accordion-content").forEach(c=>{
  const setBtn=c.querySelector(".set-alarm-btn");
  const stopBtn=c.querySelector(".stop-alarm-btn");

  let timerId=null;
  let vibeId=null;

  setBtn.onclick=()=>{
    const inputs=c.querySelectorAll("input");
    let h=parseInt(inputs[0].value||0);
    let m=parseInt(inputs[1].value||0);

    let t=new Date();
    t.setHours(h); t.setMinutes(m); t.setSeconds(0);
    if(t<new Date()) t.setDate(t.getDate()+1);

    timerId=setTimeout(()=>{
      if(!canNotify()) return;
      vibeId=setInterval(()=>navigator.vibrate(500),800);
      stopBtn.style.display="inline-block";
    }, t-new Date());

    stopBtn.style.display="inline-block";
  };

  stopBtn.onclick=()=>{
    if(timerId) clearTimeout(timerId);
    if(vibeId) clearInterval(vibeId);
    navigator.vibrate(0);
    stopBtn.style.display="none";
  };
});
</script>
</body>
</html>
