<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç´›å¤±é˜²æ­¢ã‚¢ãƒ—ãƒª</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; text-align: center; background: #f2f2f7; padding: 20px; }
  .container { background: white; padding: 30px; border-radius: 16px; margin: 0 auto; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .status { font-size: 24px; font-weight: bold; margin: 20px 0; }
  .circle { font-size: 50px; display: block; margin-bottom: 10px; }
  
  .mode-switch { display: flex; justify-content: center; margin-bottom: 20px; background: #eee; padding: 5px; border-radius: 8px; }
  .mode-btn { flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer; border-radius: 6px; font-weight: bold; color: #888; }
  .mode-btn.active { background: white; color: #007aff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

  button { width: 100%; padding: 15px; font-size: 16px; border: none; border-radius: 8px; margin-bottom: 10px; font-weight: bold; cursor: pointer; }
  #btn-connect { background: #007aff; color: white; }
  #btn-disconnect { background: #ff3b30; color: white; opacity: 0.5; }
  
  .alert-mode { background-color: #ffeaea; border: 2px solid #ff3b30; }
  .motion-mode { background-color: #e6fffa; border: 2px solid #38b2ac; }
  .alert-text { color: #ff3b30; font-weight: bold; }
  .motion-text { color: #38b2ac; font-weight: bold; }

  .location-info { margin-top: 20px; padding: 15px; background: #edf2f7; border-radius: 8px; font-size: 14px; text-align: left; display: none; }
  .location-info a { color: #007aff; text-decoration: none; font-weight: bold; }
</style>
</head>
<body>

<div class="container" id="main-container">
    <h2>ç´›å¤±é˜²æ­¢ã‚¢ãƒ—ãƒª</h2>
    
    <div class="mode-switch">
        <button id="mode-lost" class="mode-btn active" onclick="setMode('lost')">ç´›å¤±é˜²æ­¢</button>
        <button id="mode-motion" class="mode-btn" onclick="setMode('motion')">å‹•ãæ¤œçŸ¥</button>
    </div>

    <div class="status">
        <span id="circle" class="circle">ğŸ”´</span>
        <span id="text">æœªæ¥ç¶š</span>
    </div>

    <button id="btn-connect" onclick="connect()">æ¥ç¶šã™ã‚‹</button>
    <button id="btn-disconnect" onclick="disconnect()">åˆ‡æ–­ã™ã‚‹</button>
    
    <div id="last-location" class="location-info">
        <b>ğŸ“ åˆ‡æ–­åœ°ç‚¹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ:</b><br>
        <a id="map-link" href="#" target="_blank">Googleãƒãƒƒãƒ—ã§è¦‹ã‚‹</a>
        <div style="font-size:10px; color:#666; margin-top:5px;" id="timestamp"></div>
    </div>
</div>

<script>
  const SERVICE_UUID = "12345678-1234-1234-1234-1234567890ab".toLowerCase();
  const CHAR_MOTION_UUID = "12345678-1234-1234-1234-1234567890ac".toLowerCase();

  let device = null;
  let motionChar = null;
  let isManualDisconnect = false;
  let currentMode = 'lost';
  let isAlertShowing = false;
  let isCooldown = false;

  function setMode(mode) {
      currentMode = mode;
      document.getElementById('mode-lost').className = mode === 'lost' ? 'mode-btn active' : 'mode-btn';
      document.getElementById('mode-motion').className = mode === 'motion' ? 'mode-btn active' : 'mode-btn';
      
      if(device && device.gatt.connected && motionChar) {
          if(mode === 'motion') {
              motionChar.startNotifications().catch(e => console.log(e));
          } else {
              motionChar.stopNotifications().catch(e => console.log(e));
          }
          if(document.getElementById("circle").innerText === "ğŸ”µ") {
             document.getElementById("text").innerText = mode === 'motion' ? "ç›£è¦–ä¸­(å‹•ä½“)" : "æ¥ç¶šä¸­(ç´›å¤±)";
          }
      }
  }

  async function connect() {
      try {
          navigator.geolocation.getCurrentPosition(()=>{}, ()=>{});

          device = await navigator.bluetooth.requestDevice({
              filters: [{ services: [SERVICE_UUID] }]
          });

          device.addEventListener('gattserverdisconnected', onDisconnected);

          const server = await device.gatt.connect();
          const service = await server.getPrimaryService(SERVICE_UUID);

          try {
              motionChar = await service.getCharacteristic(CHAR_MOTION_UUID);
              motionChar.addEventListener('characteristicvaluechanged', (event) => {
                  onMotionDetected();
              });
              if (currentMode === 'motion') {
                  await motionChar.startNotifications();
              }
          } catch(err) {
              console.log(err);
          }

          updateUI(true);
          isManualDisconnect = false;
          alert("âœ… æ¥ç¶šã—ã¾ã—ãŸï¼\nç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰: " + (currentMode==='lost' ? "ç´›å¤±é˜²æ­¢" : "å‹•ãæ¤œçŸ¥"));

      } catch (e) {
          alert("ã‚¨ãƒ©ãƒ¼: " + e);
      }
  }

  function onMotionDetected() {
      if (currentMode !== 'motion') return;
      if (isAlertShowing || isCooldown) return;

      isAlertShowing = true;

      document.getElementById("main-container").className = "container motion-mode";
      document.getElementById("circle").innerText = "âš ï¸";
      document.getElementById("text").innerText = "å‹•ãã¾ã—ãŸï¼";
      document.getElementById("text").className = "motion-text";

      setTimeout(() => {
          alert("âš ï¸ è­¦å‘Šï¼šå‹•ãã‚’æ¤œçŸ¥ã—ã¾ã—ãŸï¼");
          
          isAlertShowing = false;
          isCooldown = true;

          if (device && device.gatt.connected) {
              updateUI(true);
          }

          setTimeout(() => {
              isCooldown = false;
          }, 5000);

      }, 100);
  }

  function disconnect() {
      if (device && device.gatt.connected) {
          isManualDisconnect = true;
          device.gatt.disconnect();
          updateUI(false);
          alert("æ‰‹å‹•ã§åˆ‡æ–­ã—ã¾ã—ãŸ");
      }
  }

  function onDisconnected(event) {
      if (isManualDisconnect) return;

      document.getElementById("circle").innerText = "âš ï¸";
      document.getElementById("text").innerText = "æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸï¼";
      document.getElementById("text").className = "alert-text";
      document.getElementById("main-container").className = "container alert-mode";
      document.getElementById("btn-connect").style.opacity = "1.0";
      document.getElementById("btn-disconnect").style.opacity = "0.5";
      
      if (currentMode === 'lost') {
          navigator.geolocation.getCurrentPosition(
              (position) => {
                  const lat = position.coords.latitude;
                  const lng = position.coords.longitude;
                  const mapUrl = `https://www.google.com/maps?q=${lat},${lng}`;
                  const time = new Date().toLocaleTimeString();

                  const locDiv = document.getElementById("last-location");
                  const link = document.getElementById("map-link");
                  
                  link.href = mapUrl;
                  document.getElementById("timestamp").innerText = `æ™‚åˆ»: ${time}`;
                  locDiv.style.display = "block";
              }
          );
          setTimeout(() => alert("âš ï¸ è­¦å‘Šï¼æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸ\n(ä½ç½®æƒ…å ±ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ)"), 100);
      } else {
          setTimeout(() => alert("âš ï¸ è­¦å‘Šï¼æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸ\n(å‹•ãç›£è¦–ã‚’ä¸­æ–­)"), 100);
      }
  }

  function updateUI(isConnected) {
      if (isConnected) {
          document.getElementById("main-container").className = "container";
          document.getElementById("text").className = "";
          document.getElementById("circle").innerText = "ğŸ”µ";
          document.getElementById("text").innerText = currentMode === 'motion' ? "ç›£è¦–ä¸­" : "æ¥ç¶šä¸­";
          document.getElementById("btn-connect").style.opacity = "0.5";
          document.getElementById("btn-disconnect").style.opacity = "1.0";
          document.getElementById("last-location").style.display = "none";
      } else {
          document.getElementById("circle").innerText = "ğŸ”´";
          document.getElementById("text").innerText = "æœªæ¥ç¶š";
          document.getElementById("btn-connect").style.opacity = "1.0";
          document.getElementById("btn-disconnect").style.opacity = "0.5";
      }
  }
</script>

</body>
</html>
